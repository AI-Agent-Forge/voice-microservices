version: "3.8"

services:
  redis:
    image: redis:7-alpine
    container_name: af_redis
    volumes:
      - redis_data:/data
    restart: unless-stopped

  minio:
    image: minio/minio:latest
    container_name: af_minio
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD}
    command: server /data --console-address ":9001"
    ports:
      - "9000:9000"
      - "9001:9001"
    volumes:
      - minio_data:/data
    restart: unless-stopped

  postgres:
    image: postgres:15-alpine
    container_name: af_postgres
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
    volumes:
      - pg_data:/var/lib/postgresql/data
    restart: unless-stopped

  asr-service:
    build:
      context: ./asr-service
      dockerfile: Dockerfile
    container_name: af_asr
    env_file:
      - .env
    environment:
      - STORAGE_ENDPOINT=${MINIO_ENDPOINT}
      - STORAGE_ACCESS_KEY=${MINIO_ROOT_USER}
      - STORAGE_SECRET_KEY=${MINIO_ROOT_PASSWORD}
      - REDIS_URL=redis://redis:6379/0
      - WHISPER_MODEL=${WHISPER_MODEL:-base}
      - WHISPER_COMPUTE_TYPE=${WHISPER_COMPUTE_TYPE:-float16}
      - WHISPER_BATCH_SIZE=${WHISPER_BATCH_SIZE:-16}
      - MOCK_MODE=${ASR_MOCK_MODE:-false}
      - HF_TOKEN=${HF_TOKEN:-}
    ports:
      - "8001:8000"
    depends_on:
      - redis
      - minio
    volumes:
      - models_cache:/models_cache
      - ./asr-service:/app
      - ./shared:/app/shared
      - asr_temp:/tmp/asr_temp
    # GPU support - uncomment if you have NVIDIA GPU with Docker GPU runtime
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    restart: unless-stopped

  alignment-service:
    build:
      context: ./alignment-service
      dockerfile: Dockerfile
    container_name: af_alignment
    env_file:
      - .env
    ports:
      - "8002:8002"
    depends_on:
      - minio
    volumes:
      - models_cache:/models_cache
      - ./alignment-service:/app
      - ./shared:/app/shared
    restart: unless-stopped

  phoneme-map-service:
    build:
      context: ./phoneme-map-service
      dockerfile: Dockerfile
    container_name: af_phonemap
    env_file:
      - .env
    ports:
      - "8003:8000"
    volumes:
      - ./phoneme-map-service:/app
      - ./shared:/app/shared
    restart: unless-stopped

  phoneme-diff-service:
    build:
      context: ./phoneme-diff-service
      dockerfile: Dockerfile
    container_name: af_phonediff
    env_file:
      - .env
    ports:
      - "8004:8000"
    volumes:
      - ./phoneme-diff-service:/app
      - ./shared:/app/shared
    restart: unless-stopped

  tts-service:
    build:
      context: ./tts-service
      dockerfile: Dockerfile
    container_name: af_tts
    env_file:
      - .env
    environment:
      - STORAGE_ENDPOINT=${MINIO_ENDPOINT}
      - STORAGE_ACCESS_KEY=${MINIO_ROOT_USER}
      - STORAGE_SECRET_KEY=${MINIO_ROOT_PASSWORD}
    ports:
      - "8005:8000"
    volumes:
      - tts_models:/models_tts
      - ./tts-service:/app
      - ./shared:/app/shared
    restart: unless-stopped

  voice-conversion-service:
    build:
      context: ./voice-conversion-service
      dockerfile: Dockerfile
    container_name: af_vc
    env_file:
      - .env
    environment:
      - STORAGE_ENDPOINT=${MINIO_ENDPOINT}
      - STORAGE_ACCESS_KEY=${MINIO_ROOT_USER}
      - STORAGE_SECRET_KEY=${MINIO_ROOT_PASSWORD}
      - REDIS_URL=redis://redis:6379/1
    ports:
      - "8006:8000"
    depends_on:
      - redis
      - minio
    volumes:
      - vc_models:/models_vc
      - ./voice-conversion-service:/app
      - ./shared:/app/shared
    restart: unless-stopped

  feedback-llm-service:
    build:
      context: ./feedback-llm-service
      dockerfile: Dockerfile
    container_name: af_feedback
    env_file:
      - .env
    environment:
      - LLM_PROVIDER=${LLM_PROVIDER}
      - LLM_API_KEY=${LLM_API_KEY}
    ports:
      - "8007:8000"
    volumes:
      - ./feedback-llm-service:/app
      - ./shared:/app/shared
    restart: unless-stopped

  orchestrator:
    build:
      context: ./pipeline-orchestrator
      dockerfile: Dockerfile
    container_name: af_orchestrator
    env_file:
      - .env
    environment:
      - REDIS_URL=redis://redis:6379/0
      - ASR_URL=http://asr-service:8000
      - ALIGN_URL=http://alignment-service:8000
      - PHONEME_MAP_URL=http://phoneme-map-service:8000
      - DIFF_URL=http://phoneme-diff-service:8000
      - TTS_URL=http://tts-service:8000
      - VC_URL=http://voice-conversion-service:8000
      - FEEDBACK_URL=http://feedback-llm-service:8000
      - STORAGE_ENDPOINT=${MINIO_ENDPOINT}
      - STORAGE_ACCESS_KEY=${MINIO_ROOT_USER}
      - STORAGE_SECRET_KEY=${MINIO_ROOT_PASSWORD}
      - DATABASE_URL=postgresql+psycopg2://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB}
    ports:
      - "9010:8000"
    depends_on:
      - asr-service
      - alignment-service
      - phoneme-map-service
      - phoneme-diff-service
      - tts-service
      - voice-conversion-service
      - feedback-llm-service
      - redis
      - minio
      - postgres
    volumes:
      - ./pipeline-orchestrator:/app
      - ./shared:/app/shared
    restart: unless-stopped

networks:
  default:
    name: af_network

volumes:
  redis_data:
  minio_data:
  pg_data:
  models_cache:
  tts_models:
  vc_models:
  asr_temp:
